<%- include('header'); -%>

<div class="page-wrapper">
    <div class="page-content">
        <nav class="page-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Ruta</a></li>
                <li class="breadcrumb-item active" aria-current="page"><%= route.name %></li>
            </ol>
        </nav>
        <div class="row">

            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Añadir Punto de Control</h6>
                        <form class="forms-sample" action="" method="post">
                            <%  if (serverMsg && valid == true) { %>
                            <div class="alert alert-success" role="alert">
                                <%= serverMsg ? serverMsg : '' %>
                            </div>
                            <% } else if (serverMsg && valid == false) { %>
                            <div class="alert alert-danger" role="alert">
                                <%= serverMsg ? serverMsg : '' %>
                            </div>
                            <% } %>
                            <div class="form-group">
                                <label>Nombre</label>
                                <input name="name" type="text" class="form-control" autocomplete="off"
                                    placeholder="Ingresa el nombre del punto de control">
                            </div>
                            <div class="form-group">
                                <label>Descripción</label>
                                <input name="description" type="text" class="form-control"
                                    placeholder="Ingresa la descripción del punto de control">
                            </div>
                            <div class="form-group">
                                <label>Método</label>
                                <select name="method" class="form-control">
                                    <option value="QR_CODE">Código QR</option>
                                    <option value="NFC">NFC</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Código</label>
                                
                                <input name="code" value="<%= code %>" type="text" class="form-control"
                                    placeholder="Ingresa la descripción del punto de control">
                            </div>

                            <div class="form-group">
                                <label>Ubicación</label>
                                <input id="checkpointLocation" readonly type="text" class="form-control" value="0,0">
                            </div>
                            
                            <input type="hidden" id="lat" name="lat" value="">
                            <input type="hidden" id="lng" name="lng" value="">
                            <input type="hidden" name="_csrf" value="<%= csrf %>">
                            <button type="submit" class="btn btn-primary mr-2">Añadir</button>
                            
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-8 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Seleccionar Localización del Punto de Control en el Mapa</h6>

                        <div id="map" style="width: 100%; height: 80%; min-height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<script src="<%= host %>assets/bundle.js"></script>
<script>
    const markersArray = []
    function initMap() {


        App.map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 19.3905944, lng: -99.1409661 },
            zoom: 15,
            styles: [{
                featureType: 'poi',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }] // hide poi (businesses) icons
            },
            {
                featureType: 'poi',
                elementType: 'geometry',
                stylers: [{ color: '#e5e5e5' }] // poi geometry color
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }] // hide local businesses labels
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }] // hide local businesses labels
            },
            {
                featureType: 'landscape',
                elementType: 'geometry',
                stylers: [{ color: '#f5f5f5' }] // buildings and so on
            },
            {
                featureType: 'road.arterial',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }] // hide arterial roads labels
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry', // highway color
                stylers: [{ color: '#dadada' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'labels.text.stroke', // highway label text stroke (contorno)
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'road',
                elementType: 'labels.text.fill', // rad label text color (fill)
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'road.local',
                elementType: 'geometry',
                stylers: [{ color: '#ffffff' }] // park roads color

            },
            {
                featureType: 'transit',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'transit.station.bus',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            }]
        });

        google.maps.event.addListener(App.map, 'click', function (e) {
            placeMarker(e.latLng)
        })

    }

    function placeMarker(location) {
        clearOverlays()
        const marker = new google.maps.Marker({
            position: location,
            map: App.map
        })
        markersArray.push(marker)
        console.log(location)
        // update checkpointLocation value
        document.getElementById('checkpointLocation').value = `${location.lat()},${location.lng()}`
        document.getElementById('lat').value = location.lat()
        document.getElementById('lng').value = location.lng()
    }

    function clearOverlays() {
        for (var i = 0; i < markersArray.length; i++) {
            markersArray[i].setMap(null);
        }
        markersArray.length = 0;
    }

</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAY5scI2sYPDGoLn2INfct1gMw5gFLIHjs&callback=initMap"></script>
<%- include('footer'); -%>