<%- include('header'); -%>

<div class="page-wrapper">
    <div class="page-content">
        <nav class="page-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Usuario</a></li>
                <li class="breadcrumb-item active" aria-current="page">ID <%= userId && userId %></li>
            </ol>
        </nav>
        <div class="row">
            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Perfil Usuario </h6>
                        <p class="card-description">Usuario: <%= userId && userId %> </p>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Campo</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="font-weight: bold;">Usuario: </td>
                                        <td><%= user.username %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Identificación: </td>
                                        <td><%= user.identification %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Nombre: </td>
                                        <td><%= user.name %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Email: </td>
                                        <td><%= user.email %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Teléfono: </td>
                                        <td><%= user.phone %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Empresa: </td>
                                        <td><%= user.company.name %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Código Ingreso: </td>
                                        <td><%= user.code %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Tipo de Usuario: </td>
                                        <td><%= user.userType %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Activo: </td>
                                        <td><%= user.active == 1 ? 'ACTIVO'  : 'INACTIVO' %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Estado: </td>
                                        <td><%= user.status %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Fecha de Registro: </td>
                                        <td><%= user.createdAt %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Fecha Última Modificación: </td>
                                        <td><%= user.updatedAt %></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Localización del usuario </h6>
                        <p class="card-description">Últimas ubicaciones registradas</p>
                        <div id="map" style="width: 100%; height: 80%; min-height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Historial de Accesos </h6>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Método</th>
                                        <th>IMEI</th>
                                        <th>ENTRADA/SALIDA</th>
                                        <th>Fecha</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <% if(user && 'guardAccesses' in user) {                                         
                                        for(access of user.guardAccesses) { %>
                                    <tr>
                                        <td><%= access.id %></td>
                                        <td><%= access.accessMethod %></td>
                                        <td><%= access.imei %></td>
                                        <td><%= access.accessType %></td>
                                        <td><%= access.createdAt %></td>
                                    </tr>

                                    <%  }}%>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Historial de Bitácoras </h6>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fecha</th>
                                        <th>Bitácora</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <% if(user && 'bitacoras' in user) {                                         
                                        for(bitacora of user.bitacoras) { %>
                                    <tr>
                                        <td><%= bitacora.id %></td>
                                        <td><%= bitacora.createdAt %></td>
                                        <td><a href="<%= host %>admin/bitacora/<%= bitacora.id %>" class="btn btn-primary mr-2">Ver Bitácora</button></td>
                                    </tr>

                                    <%  }} else {%>
                                    <tr>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Historial de Reportes </h6>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fecha</th>
                                        <th>Reporte</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    <% if(user && 'reports' in user) {                                         
                                        for(report of user.reports) { %>
                                    <tr>
                                        <td><%= report.id %></td>
                                        <td><%= report.createdAt %></td>
                                        <td><a href="<%= host %>admin/report/<%= report.id %>" class="btn btn-primary mr-2">Ver Reporte</button></td>
                                    </tr>

                                    <%  }} else {%>
                                    <tr>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>-</td>
                                    </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="<%= host %>assets/bundle.js"></script>

<script>
    const markersArray = []

    function loadData() {
        const user = JSON.parse(`<%- JSON.stringify(user) %>`);
        App.token = `<%= token %>`
        App.fetchUserProfile(user.id)
            .then((res) => {
                if (res.status == 'OK') {
                    
                    const user = res.payload
                    const location = { lat: parseFloat(user.userLocations[0].lat), lng: parseFloat(user.userLocations[0].lng) }


                    App.renderPath(user.userLocations)
                        .then((points) => {
                            clearOverlays()
                            let marker = new google.maps.Marker({
                                position: location,
                                map: App.map,
                            })

                            const infowindow = new google.maps.InfoWindow({
                                content: `<div>Usuario: <span>${user.username}</span></div><div>Nombre: <span>${user.name}</span></div><div>Empresa: <span>${user.companyId}</span></div>`
                            });

                            marker.addListener('click', function () {
                                infowindow.open(App.map, marker);
                            })

                            markersArray.push(marker)

                           
                            const path = new google.maps.Polyline({
                                path: points,
                                geodesic: true,
                                strokeColor: '#3880ff',
                                strokeOpacity: 0.8,
                                strokeWeight: 2
                            });

                            path.setMap(App.map);

                            markersArray.push(path)
                        })
                }
            })
        setTimeout(loadData, 10000)
    }

    function initMap() {
        const user = JSON.parse(`<%- JSON.stringify(user) %>`);
        const location = { lat: parseFloat(user.userLocations[0].lat), lng: parseFloat(user.userLocations[0].lng) }

        App.map = new google.maps.Map(document.getElementById('map'), {
            center: location,
            zoom: 15,
            styles: [{
                featureType: 'poi',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }] // hide poi (businesses) icons
            },
            {
                featureType: 'poi',
                elementType: 'geometry',
                stylers: [{ color: '#e5e5e5' }] // poi geometry color
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }] // hide local businesses labels
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }] // hide local businesses labels
            },
            {
                featureType: 'landscape',
                elementType: 'geometry',
                stylers: [{ color: '#f5f5f5' }] // buildings and so on
            },
            {
                featureType: 'road.arterial',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }] // hide arterial roads labels
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry', // highway color
                stylers: [{ color: '#dadada' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'labels.text.stroke', // highway label text stroke (contorno)
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'road',
                elementType: 'labels.text.fill', // rad label text color (fill)
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'road.local',
                elementType: 'geometry',
                stylers: [{ color: '#ffffff' }] // park roads color

            },
            {
                featureType: 'transit',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'transit.station.bus',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            }]

        });

        let marker = new google.maps.Marker({
            position: location,
            map: App.map,
        })

        const infowindow = new google.maps.InfoWindow({
            content: `<div>Usuario: <span>${user.username}</span></div><div>Nombre: <span>${user.name}</span></div><div>Empresa: <span>${user.company.name}</span></div>`
        });

        marker.addListener('click', function () {
            infowindow.open(App.map, marker);
        })

        markersArray.push(marker)

        loadData()
    }


    function clearOverlays() {
        for (var i = 0; i < markersArray.length; i++) {
            markersArray[i].setMap(null);
        }
        markersArray.length = 0;
    }


</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAY5scI2sYPDGoLn2INfct1gMw5gFLIHjs&callback=initMap"></script>

<%- include('footer'); -%>