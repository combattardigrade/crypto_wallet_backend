<%- include('header'); -%>

<div class="page-wrapper">
    <div class="page-content">
        <nav class="page-breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Punto de Control</a></li>
                <li class="breadcrumb-item active" aria-current="page"><%= checkpoint.id %> </li>
            </ol>
        </nav>
        <div class="row">
            <div class="col-md-4 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Detalles del Punto de Control - <%= checkpoint.name %> </h6>

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Campo</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="font-weight: bold;">ID: </td>
                                        <td><%= checkpoint.id %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Nombre: </td>
                                        <td><%= checkpoint.name %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Descripción: </td>
                                        <td><%= checkpoint.description %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Código: </td>
                                        <td><%= checkpoint.code %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Método:</td>
                                        <td><%= checkpoint.method  %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Estado: </td>
                                        <td><%= checkpoint.status %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">ID Guardia: </td>
                                        <td><%= checkpoint.user.id  %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Usuario Guardia: </td>
                                        <td><%= checkpoint.user.username %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Nombre Guardia: </td>
                                        <td><%= checkpoint.user.name %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">ID Ruta: </td>
                                        <td><%= checkpoint.route.id  %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Nombre Ruta: </td>
                                        <td><%= checkpoint.route.name %></td>
                                    </tr>

                                    <tr>
                                        <td style="font-weight: bold;">Fecha de Creación </td>
                                        <td><%= checkpoint.createdAt  %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Fecha de Última Modificación </td>
                                        <td><%= checkpoint.updatedAt  %></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">Eliminar </td>
                                        <td>
                                            <form id="deleteCheckpointForm" action="<%= host %>admin/deleteCheckpoint" method="post">
                                                <input type="hidden" name="_csrf" value="<%= csrf %>">
                                                <input type="hidden" name="checkpointId" value="<%= checkpoint.id %>" />
                                                <button id="deleteBtn" class="btn btn-danger mr-2">Eliminar</button>
                                            </form>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>


                    </div>
                </div>
            </div>
            <div class="col-md-8 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12">
                                <div id="map" style="width: 100%; height: 80%; min-height: 400px;"></div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-6">
                                <h6 class="card-title">Actualizar del Punto de Control</h6>
                                <form class="forms-sample" action="" method="post">
                                    <%  if (serverMsg && valid == true) { %>
                                    <div class="alert alert-success" role="alert">
                                        <%= serverMsg ? serverMsg : '' %>
                                    </div>
                                    <% } else if (serverMsg && valid == false) { %>
                                    <div class="alert alert-danger" role="alert">
                                        <%= serverMsg ? serverMsg : '' %>
                                    </div>
                                    <% } %>
                                    <div class="form-group">
                                        <label for="exampleInputUsername1">Selecciona el campo a cambiar</label>
                                        <select name="fieldToChange" id="" class="form-control">
                                            <option value="name">Nombre</option>
                                            <option value="description">Descripción</option>
                                            <option value="code">Código</option>
                                            <option value="method">Método</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Nuevo valor</label>
                                        <input name="newValue" type="text" class="form-control"
                                            placeholder="Ingresa el nuevo valor del campo seleccionado">
                                    </div>
                                    <input type="hidden" name="_csrf" value="<%= csrf %>">

                                    <button type="submit" class="btn btn-primary mr-2">Guardar</button>

                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

    </div>

</div>
<script src="<%= host %>assets/bundle.js"></script>
<script>
    const markersArray = []
    const checkpoint = JSON.parse(`<%- JSON.stringify(checkpoint) %>`)

    document.getElementById('deleteBtn').addEventListener('click', function (e) {
        e.preventDefault()
        let response = confirm('¿Estás seguro que quieres eliminar el punto de control?')
        if (response == true) {
            document.getElementById('deleteCheckpointForm').submit()
        }
    })



    function initMap() {

        App.map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: parseFloat(checkpoint.lat), lng: parseFloat(checkpoint.lng) },
            zoom: 15,
            styles: [{
                featureType: 'poi',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }] // hide poi (businesses) icons
            },
            {
                featureType: 'poi',
                elementType: 'geometry',
                stylers: [{ color: '#e5e5e5' }] // poi geometry color
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }] // hide local businesses labels
            },
            {
                featureType: 'poi.park',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }] // hide local businesses labels
            },
            {
                featureType: 'landscape',
                elementType: 'geometry',
                stylers: [{ color: '#f5f5f5' }] // buildings and so on
            },
            {
                featureType: 'road.arterial',
                elementType: 'labels',
                stylers: [{ visibility: 'off' }] // hide arterial roads labels
            },
            {
                featureType: 'road.highway',
                elementType: 'geometry', // highway color
                stylers: [{ color: '#dadada' }]
            },
            {
                featureType: 'road.highway',
                elementType: 'labels.text.stroke', // highway label text stroke (contorno)
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'road',
                elementType: 'labels.text.fill', // rad label text color (fill)
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'road.local',
                elementType: 'geometry',
                stylers: [{ color: '#ffffff' }] // park roads color

            },
            {
                featureType: 'transit',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.fill',
                stylers: [{ color: '#676767' }]
            },
            {
                featureType: 'transit',
                elementType: 'labels.text.stroke',
                stylers: [{ color: '#ffffff' }]
            },
            {
                featureType: 'transit.station.bus',
                elementType: 'labels.icon',
                stylers: [{ visibility: 'off' }]
            }]
        });
        console.log(checkpoint)
        let marker = new google.maps.Marker({
            position: { lat: parseFloat(checkpoint.lat), lng: parseFloat(checkpoint.lng) },
            map: App.map,
            label: {
                text: checkpoint.name.toString(),
                color: checkpoint.status == 'ACTIVE' ? '#ff0000' : '#007bff',
                fontWeight: 'bold',
                paddingTop: "20px",
                background: 'black'
            },
            icon: checkpoint.status == 'ACTIVE' ? pinSymbol('#ff0000') : pinSymbol('#007bff')
        })

        markersArray.push(marker)

        const infowindow = new google.maps.InfoWindow({
            content: `<div>Nombre: <span>${checkpoint.name}</span></div><div>Estado: <span>${checkpoint.status}</span></div>`
        });

        marker.addListener('click', function () {
            infowindow.open(App.map, marker);
        })

    }

    function pinSymbol(color) {
        return {
            path: 'M 0,0 C -2,-20 -10,-22 -10,-30 A 10,10 0 1,1 10,-30 C 10,-22 2,-20 0,0 z M -2,-30 a 2,2 0 1,1 4,0 2,2 0 1,1 -4,0',
            fillColor: color,
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 1,
            scale: 1,
        };
    }
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAY5scI2sYPDGoLn2INfct1gMw5gFLIHjs&callback=initMap"></script>
<%- include('footer'); -%>